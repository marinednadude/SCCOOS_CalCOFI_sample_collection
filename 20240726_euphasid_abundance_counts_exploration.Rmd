---
title: "Species Index Mapper"
author: "Zack Gold"
date: "2024-05-06"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

```

```{r, warning=FALSE, include=FALSE }
library(patchwork)
library(ggpubr)
library(tidyverse)
library(here)
library(readxl)
library("rnaturalearth")
library("rnaturalearthdata")
library(sf)
library(ggpubr)
library(patchwork)
library(knitr)
library(ggpmisc)
library('mgcv')
library('brms')
library('ggplot2')
devtools::install_github('gavinsimpson/schoenberg')
library('schoenberg')
theme_set(theme_bw())
library(lme4)
library(rstanarm)
library(modelr)
library(tidybayes)
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(ggdist)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(brms)
library(ggrepel)
library(RColorBrewer)
library(gganimate)
library(posterior)
library(distributional)
library(zoo)
library(cmocean)


world <- ne_countries(scale = "medium", returnclass = "sf")

```


```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}
#load in the Krill taxonomy data

BTEDB_tax <- read_xlsx(here("knb-lter-cce.313.1","BTEDB_tax.xlsx")) 

BTEDB_tax %>% 
  mutate(., Ohman_tax=str_remove(Ohman_tax,"_Abundance")) %>% #remove abundance tag
  separate(Ohman_tax, into=c("Genus","species","phase","type"), sep="_") %>%  #split name into components
  mutate(., type = replace_na(type, "")) %>%  #get rid of NAs
  mutate(ID_Microscopy=str_c(Genus,species, sep=" "), #pull together binomial name
         Phase=str_c(phase,type,sep="-")) %>%  #pull together phase
  dplyr::select(ID_Microscopy, Phase)%>%  
  distinct() -> visual_tax_names # make this distinct 
```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}
# Load in the Brinton and Townsend Euphausiid Database - CCE-LTER
# aka krill
BTEDB <- read.csv(here("knb-lter-cce.313.1","BTEDB_Abundances.csv"))

# Pull in Ed Weber's awesome code to merge the Cast and Bottle Data
ed_key <- read.csv(here("data","20240612_key_ed_webber.csv"))

# Clean Up the Metadata
BTEDB %>%
  mutate(., PIC_RowNumber=RowNumber, # Clean Up Header
        TowBegin= as.POSIXct(TowBegin, format = "%Y-%m-%d %H:%M:%S"), # Fix Times
        TowEnd= as.POSIXct(TowEnd,  format = "%Y-%m-%d %H:%M:%S")) %>% # Fix Times
  pivot_longer(cols=`Euphausia_brevis_adult_Abundance`:`Thysanopoda_pectinata_juvenile_Abundance`,names_to = "Ohman_tax", values_to = "Count_permsq2") %>% 
  separate(Ohman_tax, into=c("Genus","species","phase","type"), sep="_", remove = F) %>% 
  mutate(., type = replace_na(type, "")) %>% 
  mutate(ID_Microscopy=str_c(Genus,species, sep=" "), 
         Phase=str_c(phase,type,sep="-")) %>% 
  dplyr::select(PIC_RowNumber,
Date,
MaxDepth,TowBegin,TowEnd,Ohman_tax,Genus,species, phase,type,Count_permsq2,ID_Microscopy,Phase
) %>% 
  left_join(ed_key)  %>% 
  mutate(., Station = as.numeric(N_Station),
        Line = N_Line) %>% 
  filter(., N_lat > 27) %>% 
  filter(., N_lat < 40) %>% 
  filter(., N_lon < -110) %>% 
   mutate(., site= str_c(N_Line,"_",N_Station),
         cruise_site = str_c(N_Cruise,":",N_Line,"_",N_Station))-> long_microscopy

  
```


# Abundance of Euphausia pacifica over Time

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.height=20, fig.width=20}

long_microscopy %>% 
  filter(., str_detect(Ohman_tax,"adult")) -> adult_data

long_microscopy %>% 
  filter(., Count_permsq2 > 0) %>% 
  ungroup() %>% 
  count(ID_Microscopy) %>% 
  arrange(desc(`n`)) %>% 
  filter(., n> 1000) -> abundant_species
  
abundant_species  %>% kable()

```
<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}

bottle_data <- read.csv(here("data","CalCOFI_Database_194903-202105_csv","194903-202105_Bottle.csv"), header = T,check.names = F) #CTD bottle data

cast_data <- read.csv(here("data","CalCOFI_Database_194903-202105_csv","194903-202105_Cast.csv"), header = T,check.names = F) #CTD Cast data

cast_data %>% 
  left_join(bottle_data, relationship="many-to-many") -> cast_bottle

cast_bottle %>% 
  mutate(., Station = as.double(Rpt_Sta),
         Line = as.double(Rpt_Line),
         year=Year) %>% 
       mutate(., Date = as.Date(Date, "%m/%d/%Y"),
              year= year(Date),
        month= month(Date),
        season = case_when(month < 3 ~"Winter",
                           month < 6 ~"Spring",
                           month < 9 ~"Summer",
                           month < 12 ~"Fall",
                           TRUE ~"Winter")) %>% 
 mutate(., site= str_c(Line,"_",Station),
         year_site = str_c(year,":",Line,"_",Station),
         year_season_site = str_c(year,":",season,":",Line,"_",Station),
         cruise_site = str_c(Cruise,":",Line,"_",Station)) -> cast_bottle_fixed

adult_data %>% 
  dplyr::select(PIC_RowNumber,Cst_Cnt,site,cruise_site) %>% 
  distinct()
  
```

# Full Merge
```{r}
adult_data %>% 
  left_join(cast_bottle_fixed, by=c("cruise_site"), relationship="many-to-many") %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) -> adult_data_chem_full


```

```{r}

#O2sat already calculated for recent data so ignoring this
#  mutate(O2meas = O2ml_L/31.9988/(STheta + 1000)*(1000^2),
#         O2sat = gsw_O2sol_SP_pt(Salnty, T_degC), SatPct = (O2meas/O2sat)*100) %>% 
#  relocate(c(O2meas, O2sat, SatPct), .after = O2ml_L)

Cast_ID

cast_bottle_fixed %>% 
   filter(., year > 1993) -> cast_bottle_fixed_recent

cast_bottle_fixed_recent %>% 
  group_by(Cast_ID) %>% 
  dplyr::summarise(temp_na=sum(is.na(T_degC)),
                   sal_na=sum(is.na(Salnty)),
                   o2_na=sum(is.na(O2ml_L)),
                   sat_na=sum(is.na(O2Sat)),
                          tot=n()) %>% 
  filter(., temp_na < (tot-2) ) %>% 
  filter(., sal_na < (tot-2) ) %>% 
    filter(., o2_na < (tot-2) ) %>% 
    filter(., sat_na < (tot-2) )-> casts_to_keep
```


```{r}
cast_bottle_fixed_recent %>% 
  filter(., Cast_ID %in% casts_to_keep$Cast_ID)-> cast_bottle_fixed_recent 

cast_bottle_fixed_recent -> test

test %>% 
  group_by(Cst_Cnt) %>% 
  nest() -> test_nest_cast

model_holder <- tibble(test_nest_cast$Cst_Cnt)
model_holder$Depthm_1mbin <- list(0)
model_holder$T_degC_1mbin <- list(0)
model_holder$Salnty_1mbin <- list(0)
model_holder$O2ml_L_1mbin <- list(0)
model_holder$O2Sat_1mbin <- list(0)

i=1

for (i in 1:nrow(model_holder)) {
print(i)
model_holder$Depthm_1mbin[[i]] <- approx(test_nest_cast$data[[i]]$Depthm,test_nest_cast$data[[i]]$T_degC, method="linear", xout=seq(min(test_nest_cast$data[[i]]$Depthm),max(test_nest_cast$data[[i]]$Depthm),by=1))$x
model_holder$T_degC_1mbin[[i]] <- approx(test_nest_cast$data[[i]]$Depthm,test_nest_cast$data[[i]]$T_degC, method="linear", xout=seq(min(test_nest_cast$data[[i]]$Depthm),max(test_nest_cast$data[[i]]$Depthm),by=1))$y
model_holder$Salnty_1mbin[[i]] <- approx(test_nest_cast$data[[i]]$Depthm,test_nest_cast$data[[i]]$Salnty, method="linear", xout=seq(min(test_nest_cast$data[[i]]$Depthm),max(test_nest_cast$data[[i]]$Depthm),by=1))$y
model_holder$O2ml_L_1mbin[[i]] <- approx(test_nest_cast$data[[i]]$Depthm,test_nest_cast$data[[i]]$O2ml_L, method="linear", xout=seq(min(test_nest_cast$data[[i]]$Depthm),max(test_nest_cast$data[[i]]$Depthm),by=1))$y
model_holder$O2Sat_1mbin[[i]] <- approx(test_nest_cast$data[[i]]$Depthm,test_nest_cast$data[[i]]$O2Sat, method="linear", xout=seq(min(test_nest_cast$data[[i]]$Depthm),max(test_nest_cast$data[[i]]$Depthm),by=1))$y
}


model_holder %>% 
  pivot_longer(., cols=`Depthm_1mbin`:`O2Sat_1mbin`, values_to = "values", names_to = "metric") %>% 
  unnest(values) %>% 
  group_by(`test_nest_cast$Cst_Cnt`,metric) %>% 
  mutate(id = row_number()) %>% 
  pivot_wider(., values_from = c("values"), names_from = "metric", values_fill = NA) %>% 
  dplyr::select(Cst_Cnt=`test_nest_cast$Cst_Cnt`,Depthm_1mbin,T_degC_1mbin, Salnty_1mbin, O2ml_L_1mbin, O2Sat_1mbin) -> one_m_bin_Cst_Cnt


```


```{r}
cast_bottle_fixed_recent %>% 
  dplyr::select(Cst_Cnt, cruise_site, Date, Year, Month, Julian_Date, Julian_Day,Lat_Dec, Lon_Dec, season,site,year_site, year_season_site, Bottom_D) %>% distinct() %>% 
  left_join(one_m_bin_Cst_Cnt) -> binned_env_data
  
binned_env_data %>% 
  dplyr::select(site, Lat_Dec, Lon_Dec) %>% 
  distinct() -> to_plot


```
# Map of Samples to Find the Hot Zone Site

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}


min_lat <- min(32)
max_lat <- max(35)

min_lon <- min(-121)
max_lon <- max(-117)
  
  ggplot(data = world) +
   geom_sf() +
    geom_label(data=to_plot, aes(x = Lon_Dec, y = Lat_Dec, label=site), size=2) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") 
  
  #90 35 and 90 37
```
# Focus on site 90 35

```{r}
library(plotly)
binned_env_data %>% 
  filter(site=="90_35") %>% 
  ggplot(aes(x=O2Sat_1mbin, colour=Depthm_1mbin, y=T_degC_1mbin)) + geom_point(alpha=0.05) 

```

```{r}

binned_env_data %>% 
  ggplot(aes(x=O2ml_L_1mbin, y=T_degC_1mbin)) + geom_point(alpha=0.05) 

```

```{r}

binned_env_data %>% 
  filter(site %in% c("90_35", "93.3_35")) %>% 
  filter(., Depthm_1mbin==55) %>% 
  ggplot(aes(y=O2ml_L_1mbin, x=Date)) + geom_point()+ facet_wrap(site~.)

```

```{r}
library(plotly)
binned_env_data %>% 
  filter(site=="93.3_35") %>% 
  filter(., Depthm_1mbin==55) %>% 
  ggplot(aes(y=O2ml_L_1mbin, x=Date)) + geom_point()  

```

### Oxygen Satuation
```{r}

binned_env_data %>% 
  filter(site %in% c("90_35", "93.3_35")) %>% 
  ggplot(aes(x=Date, y=Depthm_1mbin, colour=O2Sat_1mbin)) + scale_y_reverse() + geom_point() + scale_colour_cmocean( name = "oxy") +facet_wrap(site~.)
```

```{r}

binned_env_data %>% 
  filter(site %in% c("90_30", "93.3_30")) %>% 
  ggplot(aes(x=Date, y=Depthm_1mbin, colour=O2Sat_1mbin)) + scale_y_reverse() + geom_point() + scale_colour_cmocean( name = "oxy") +facet_wrap(site~.)
```

### Oxygen
```{r}
binned_env_data %>% 
  filter(site %in% c("90_35", "93.3_35")) %>% 
  ggplot(aes(x=Date, y=Depthm_1mbin, colour=O2ml_L_1mbin)) + scale_y_reverse() + geom_point() + scale_colour_cmocean( name = "oxy") +facet_wrap(site~.)

```

### Temperature
```{r}
binned_env_data %>% 
  filter(site %in% c("90_30", "93.3_30")) %>% 
  filter(., T_degC_1mbin <30) %>% 
  ggplot(aes(x=Date, y=Depthm_1mbin, colour=T_degC_1mbin)) + scale_y_reverse() + geom_point() + scale_colour_cmocean( name = "thermal")  +facet_wrap(site~.)

```

```{r}
adult_data_chem_full %>% 
  filter(site.y %in% c("90_30", "93.3_30")) %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) -> krill_90_35

krill_90_35 %>% 
  dplyr::select(PIC_RowNumber,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
  filter(., Count_permsq2 >0) %>% 
  group_by(ID_Microscopy) %>% 
  count() %>% 
  arrange(desc(n))
  
```

```{r}

adult_data %>% 
  mutate(., Year= as.numeric(str_sub(Date, start=1, end=4))) %>% 
  filter(., Year > 1993) %>% 
      mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  left_join(binned_env_data, by="cruise_site") %>% 
  group_by(cruise_site, site=site.y, season,year_site,year_season_site, Date.x, Lat_Dec, Lon_Dec,ID_Microscopy) %>% 
  dplyr::summarise(., mean_O2_sat= mean(O2Sat_1mbin), mean_temp = mean(T_degC_1mbin), PA=mean(PA),Count_permsq2=mean(Count_permsq2)) %>% 
  mutate(., PAc=as.character(PA))-> krill_mean

krill_mean %>% 
  ggplot(aes(x=mean_O2_sat, colour=PAc, y=mean_temp)) + geom_point(alpha=0.2) +facet_wrap(~ID_Microscopy)
```

```{r}

krill_mean %>% 
  left_join(Hypoxic_proportion) %>% 
  left_join(depth_of_hypoxia) -> metric_comp


metric_comp %>% 
  ggplot(., aes(x=DoH, y=mean_temp, colour=mean_O2_sat)) + geom_point()

metric_comp %>% 
  ggplot(., aes(x=DoH, y=mean_O2_sat)) + geom_point()

metric_comp %>% 
  ggplot(., aes(x=DoH, y=mean_O2_sat, colour=Hypoxic_proportion)) + geom_point()

metric_comp %>% 
  ggplot(., aes(colour=DoH, y=mean_O2_sat, x=Hypoxic_proportion)) + geom_point()
```


```{r}
  
adult_data_chem_full %>% 
  filter(site.y %in% c("90_30", "93.3_30")) %>% 
  ggplot(aes(x=Date.y, y=Count_permsq2)) + geom_line()  +facet_wrap(Ohman_tax ~site.y, ncol=1, scales = "free_y")

```

```{r}

adult_data_chem_full %>% 
  filter(site.y=="90_35") %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  ggplot(aes(x=Date.y, y=PA)) + geom_point()  +facet_wrap(Ohman_tax ~., ncol=1)

```


```{r}
binned_env_data %>% 
  filter(., Depthm_1mbin > 200) %>% 
  group_by(cruise_site, site, Date) %>% 
  mutate(., Hypoxic = if_else(O2Sat_1mbin <20, 1,0)) %>% 
  dplyr::summarise(Hypoxic_proportion = mean(Hypoxic)) -> Hypoxic_proportion

```

#Density hypoxia proportion
```{r}

Hypoxic_proportion %>% 
    filter(site %in% c("90_35", "93.3_35")) %>% 
  ggplot(., aes(x=Date, y=Hypoxic_proportion, color=site)) +geom_point()

Hypoxic_proportion %>% 
    filter(site %in% c("90_35", "93.3_35")) %>% 
  ggplot(., aes(x=Hypoxic_proportion, color=site)) +geom_density()

```

```{r}

krill_mean %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA=as.character(PA)) %>% 
  left_join(Hypoxic_proportion) %>% 
  ggplot(aes(x=Hypoxic_proportion, color=PA,group=PA, fill=PA)) + geom_density(alpha=0.2) +facet_wrap(ID_Microscopy~.)


```

```{r}

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
  filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(Hypoxic_proportion) %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  ggplot(aes(x=Hypoxic_proportion, y=log(Count_permsq2+1))) +geom_point()+   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Hypoxic_proportion")


```


```{r}

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
  filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(Hypoxic_proportion) %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  ggplot(aes(x=Hypoxic_proportion, y=PA)) +geom_point()+   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Hypoxic_proportion")


```

```{r}

krill_mean %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
  left_join(Hypoxic_proportion) %>% 
  filter(., PAc >0) %>% 
 ggplot(aes(y=mean_temp, x=Hypoxic_proportion)) +
  stat_density_2d(aes(fill = ..level..), geom = "polygon", colour="white") +
  facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + 
  xlab("Proportion of Upper 100m that is Hypoxic")+theme_pubclean() + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
```

```{r}

krill_mean %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
  left_join(Hypoxic_proportion) %>% 
  filter(., ID_Microscopy=="Euphausia recurva") %>% 
 ggplot(aes(y=mean_temp, x=Hypoxic_proportion)) +
  stat_density_2d(aes(fill = ..level..), geom = "polygon", colour="white") +
  facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + 
  xlab("Proportion of Upper 100m that is Hypoxic")+theme_pubclean() + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
```

```{r}

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
  filter(., ID_Microscopy =="Nematoscelis difficilis") %>% 
  left_join(Hypoxic_proportion) %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  ggplot(aes(x=Hypoxic_proportion, y=PA)) +geom_point()+   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Hypoxic_proportion")


```
# Counts versus Depth of Hypoxia O2 ml/L

```{r}
binned_env_data %>% 
  group_by(cruise_site) %>% 
  mutate(., Hypoxic = O2ml_L_1mbin < 2) %>% 
  filter(., Hypoxic==TRUE ) %>% 
  group_by(cruise_site) %>% 
  slice(which.min(Depthm_1mbin)) %>% dplyr::select(cruise_site, DoH=Depthm_1mbin) -> depth_of_hypoxia

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
    filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(x=DoH, y=log10(Count_permsq2+1))) +geom_point()+   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Depth of Hypoxia (m)")


```
# Counts versus Depth of Hypoxia O2 Sat
```{r}
binned_env_data %>% 
  group_by(cruise_site) %>% 
  mutate(., Hypoxic = O2Sat_1mbin < 20) %>% 
  filter(., Hypoxic==TRUE ) %>% 
  group_by(cruise_site) %>% 
  slice(which.min(Depthm_1mbin)) %>% dplyr::select(cruise_site, DoH=Depthm_1mbin) -> depth_of_hypoxia

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
    filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(x=DoH, y=log10(Count_permsq2+1))) +geom_point()+   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Depth of Hypoxia (m)")


```

# Counts versus Depth of Hypoxia O2 Sat
```{r}
binned_env_data %>% 
  group_by(cruise_site) %>% 
  mutate(., Hypoxic = O2Sat_1mbin < 20) %>% 
  filter(., Hypoxic==TRUE ) %>% 
  group_by(cruise_site) %>% 
  slice(which.min(Depthm_1mbin)) %>% dplyr::select(cruise_site, DoH=Depthm_1mbin) -> depth_of_hypoxia

my.formula <- y ~ x

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
    filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(x=DoH, y=PA)) +geom_point()+   geom_smooth(method = "lm", family=binomial) + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE) + xlab("Depth of Hypoxia (m)")


```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=20, fig.height=12}

suppressWarnings({ 
 adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(y=PA, x=DoH)) + geom_point(alpha=0.4) +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(
    method="glm",
    method.args=list(family="binomial"),
  ) +
  stat_poly_eq(use_label(c("adj.R2", "p")),label.y.npc = 0.7, size=4) +xlab("Depth of Hypoxia") + ylab("Presence/Absence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
}) 
```

```{r}

krill_mean %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA=as.character(PA)) %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(x=DoH, color=PA,group=PA, fill=PA)) + geom_density(alpha=0.2) +facet_wrap(ID_Microscopy~.)


```

```{r}

krill_mean %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA=as.character(PA)) %>% 
  left_join(Hypoxic_proportion) %>% 
  ggplot(aes(x=Hypoxic_proportion, color=PA,group=PA, fill=PA)) + geom_density(alpha=0.2) +facet_wrap(ID_Microscopy~.)


```

```{r}

adult_data_chem_full %>% 
    dplyr::select(cruise_site,Count_permsq2,ID_Microscopy) %>% 
  distinct() %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA=as.character(PA)) %>% 
  left_join(Hypoxic_proportion) %>% 
  ggplot(aes(x=Hypoxic_proportion, color=PA,group=PA, fill=PA)) + geom_density(alpha=0.2) +facet_wrap(ID_Microscopy~.)

```

```{r}

krill_mean %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
  left_join(Hypoxic_proportion) %>% 
  left_join(depth_of_hypoxia) %>% 
  ggplot(aes(x=DoH, colour=PAc, y=mean_temp)) + geom_point(alpha=0.2) +facet_wrap(~ID_Microscopy)

```


```{r}
binned_env_data %>% 
  filter(., Depthm_1mbin > 200) %>% 
  group_by(cruise_site, site, Date) %>% 
  mutate(., Hypoxic = if_else(O2Sat_1mbin <20, 1,0)) %>% 
  dplyr::summarise(Hypoxic_proportion = mean(Hypoxic)) -> Hypoxic_proportion

binned_env_data %>% 
  group_by(cruise_site) %>% 
  mutate(., Hypoxic = O2Sat_1mbin < 20) %>% 
  filter(., Hypoxic==TRUE ) %>% 
  group_by(cruise_site) %>% 
  slice(which.min(Depthm_1mbin)) %>% dplyr::select(cruise_site, DoH=Depthm_1mbin) -> depth_of_hypoxia

krill_mean %>% 
  left_join(Hypoxic_proportion) %>% 
  left_join(depth_of_hypoxia) %>% 
  mutate(., Year = str_sub(year_site,1,4)) %>% 
  filter(., Year %in% c(1997,1998,2010,2011,2012,2013, 2014, 2015, 2016))-> map_2014

  ggplot(data = world) +
   geom_sf() +
    geom_point(data=map_2014, aes(x = Lon_Dec, y = Lat_Dec,colour=Hypoxic_proportion),size=1.5 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(Year~.) +scale_colour_viridis_c(option = "mako", direction=-1, begin = 0,
  end = 0.7) + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        )


```

```{r}


  ggplot(data = world) +
   geom_sf() +
    geom_point(data=map_2014, aes(x = Lon_Dec, y = Lat_Dec, size=DoH,colour=DoH) ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(.~Year) +scale_colour_viridis_c(option = "mako", direction=-1, begin = 0,
  end = 0.7) + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        )


```

```{r}


  ggplot(data = world) +
   geom_sf() +
    geom_point(data=map_2014, aes(x = Lon_Dec, y = Lat_Dec,colour=mean_O2_sat),alpha=0.6 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(.~Year) +scale_colour_viridis_c(option = "mako", direction=-1, begin = 0,
  end = 0.7) + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        )


```


# Map of Samples

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}

long_microscopy %>% 
  dplyr::select(year, season, site) %>% 
  distinct() %>% 
  group_by(site, season) %>% 
  count() -> group_by_site_all

min_lat <- min(long_microscopy$N_lat)
max_lat <- max(long_microscopy$N_lat)

min_lon <- min(long_microscopy$N_lon)
max_lon <- max(long_microscopy$N_lon)

long_microscopy %>% 
  dplyr::select(site, season, N_lat, N_lon) %>% 
  distinct() -> lat_lot_back_all

lat_lot_back_all %>% 
  group_by(site, season) %>% 
  slice(1) ->lat_lot_back_all

group_by_site_all %>% 
  left_join(lat_lot_back_all) -> group_by_site_all
  
  ggplot(data = world) +
   geom_sf() +
    geom_point(data=group_by_site_all, aes(x = N_lon, y = N_lat, size=n,colour=n),alpha=0.6 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(.~season) +scale_colour_viridis_c(option = "mako", direction=-1, begin = 0,
  end = 0.7) + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        )
```

# Below is OLD



# Abundance of Euphausia pacifica over Time

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.height=20, fig.width=20}

long_microscopy %>% 
  filter(., str_detect(Ohman_tax,"adult")) %>% 
  filter(., season=="Spring")-> adult_data

min_lat <- min(adult_data$N_lat)
max_lat <- max(adult_data$N_lat)

min_lon <- min(adult_data$N_lon)
max_lon <- max(adult_data$N_lon)

adult_data %>% 
  filter(.,ID_Microscopy == "Euphausia pacifica") -> eup

  ggplot(data = world) +
   geom_sf() +
    geom_point(data=eup, aes(x = N_lon, y = N_lat,colour=log10(Count_permsq2)),alpha=0.6 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(ID_Microscopy~year) +scale_colour_viridis_c(option = "magma", begin = 0,
  end = 0.7) +theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        )
```

<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>


# Most Detected Taxa

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}

long_microscopy %>% 
  filter(., Count_permsq2 > 0) %>% 
  ungroup() %>% 
  count(ID_Microscopy) %>% 
  arrange(desc(`n`)) %>% 
  filter(., n> 1000) -> abundant_species
  
abundant_species  %>% kable()

```
<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}

bottle_data <- read.csv(here("data","CalCOFI_Database_194903-202105_csv","194903-202105_Bottle.csv"), header = T,check.names = F)

cast_data <- read.csv(here("data","CalCOFI_Database_194903-202105_csv","194903-202105_Cast.csv"), header = T,check.names = F)

cast_data %>% 
  left_join(bottle_data, relationship="many-to-many") -> cast_bottle

cast_bottle %>% 
  mutate(., Station = as.double(Rpt_Sta),
         Line = as.double(Rpt_Line),
         year=Year) %>% 
       mutate(., Date = as.Date(Date, "%m/%d/%Y"),
              year= year(Date),
        month= month(Date),
        season = case_when(month < 3 ~"Winter",
                           month < 6 ~"Spring",
                           month < 9 ~"Summer",
                           month < 12 ~"Fall",
                           TRUE ~"Winter")) %>% 
 mutate(., site= str_c(Line,"_",Station),
         year_site = str_c(year,":",Line,"_",Station),
         year_season_site = str_c(year,":",season,":",Line,"_",Station)) -> cast_bottle_fixed

cast_bottle_fixed$year_season_site %>%  unique()
adult_data$year_season_site %>%  unique()

cast_bottle_fixed$Cst_Cnt
adult_data$Cst_Cnt
adult_data %>% 
  filter(., year_season_site %in% issues$year_season_site.x)

adult_data %>% 
  left_join(cast_bottle_fixed, by=c("Cst_Cnt")) %>% 
    dplyr::select(year_season_site.x, year_season_site.y) %>% 
  distinct() %>% 
  mutate(., same = if_else(year_season_site.x==year_season_site.y, "same","different")) %>% 
  filter(., same=="different") -> issues

#these appear to just be minor rounding issues but merging on Cst_Cnt seems to work

```


```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}

cast_bottle_fixed %>% 
  mutate(., Depthm=as.numeric(Depthm)) %>% 
  mutate(., Depth_bin = case_when(Depthm < 211 ~"Upper_210",
                                  Depthm < 501 ~"210_500",
                                  TRUE ~"Deeper_500")) %>% 
  group_by(year_season_site, year, season, site,Depth_bin) %>% 
  dplyr::summarise(mean_temp = mean(T_degC,na.rm = TRUE),mean_sal = mean(Salnty,na.rm = TRUE),mean_O2ml_L = mean(O2ml_L,na.rm = TRUE),mean_O2Sat = mean(O2Sat,na.rm = TRUE)) -> mean_bottle_Data
  


adult_data %>% 
  left_join(cast_bottle_fixed, by=c("Cst_Cnt"), relationship="many-to-many") %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
  mutate(., Depthm=as.numeric(Depthm)) %>% 
  mutate(., Depth_bin = case_when(Depthm < 211 ~"Upper_210",
                                  Depthm < 501 ~"210_500",
                                  TRUE ~"Deeper_500")) %>% 
  group_by(year_season_site=year_season_site.y, year=year.y, season=season.y, site=site.y,Depth_bin, ID_Microscopy,Count_permsq2) %>% 
  dplyr::summarise(mean_temp = mean(T_degC,na.rm = TRUE),mean_sal = mean(Salnty,na.rm = TRUE),mean_O2ml_L = mean(O2ml_L,na.rm = TRUE),mean_O2Sat = mean(O2Sat,na.rm = TRUE), Count_permsq2=mean(Count_permsq2))-> adult_data_chem
  

adult_data %>% 
  left_join(cast_bottle_fixed, by=c("Cst_Cnt"), relationship="many-to-many") %>% 
  filter(., ID_Microscopy %in% abundant_species$ID_Microscopy) %>% 
  select(year_season_site=year_season_site.y, year=year.y, season=season.y, site=site.y, ID_Microscopy,Count_permsq2,T_degC, O2ml_L,O2Sat,Depthm, Lat_Dec,Lon_Dec)-> adult_data_chem_full


```

```{r}


```
# Depth of Hypoxia
```{r}

adult_data_chem_full %>% 
  mutate(., Hypoxic = O2ml_L < 2) %>% 
  filter(., Hypoxic==TRUE ) %>% 
  group_by(year_season_site) %>% 
  slice(which.min(Depthm)) %>% 
  dplyr::select(year_season_site,Depth_of_hypoxia=Depthm) -> DOH

DOH %>% 
  filter(., is.na(Depth_of_hypoxia))
DOH %>% 
  ggplot(aes(x=Depth_of_hypoxia)) +geom_histogram()

adult_data_chem_full %>% 
  left_join(DOH) %>% 
  mutate(., Depth_of_hypoxia = if_else(is.na(Depth_of_hypoxia), 1000,Depth_of_hypoxia))-> adult_data_chem_full
```


# Abundance

## Temperature

```{r, echo=FALSE, hide=TRUE, warnings=FALSE, message=FALSE, fig.width=12, fig.height=12}



suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=log10(Count_permsq2+1), x=mean_temp)) + geom_point() +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE)+xlab("Average Temperature Upper 210m") + ylab("log10(Count per m^2+1)") +theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 

}) 
```
# 10m Temp
```{r, echo=FALSE, hide=TRUE, warnings=FALSE, message=FALSE, fig.width=12, fig.height=12}

my.formula <- y ~ x


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem_full %>% 
  filter(., Depthm ==10 ) %>% 
  ggplot(aes(y=log10(Count_permsq2+1), x=T_degC)) + geom_point() +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE)+xlab("Average Temperature Upper 210m") + ylab("log10(Count per m^2+1)") +theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 

}) 
```
<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>

# Depth of Hypoxia
```{r, echo=FALSE, hide=TRUE, warnings=FALSE, message=FALSE, fig.width=12, fig.height=12}

my.formula <- y ~ x


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem_full %>% 
  ggplot(aes(y=log10(Count_permsq2+1), x=Depth_of_hypoxia)) + geom_point() +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE)+xlab("Depth of Hypoxia") + ylab("log10(Count per m^2+1)") +theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 

}) 
```


# Map of Depth of Hypoxia
```{r}

adult_data_chem_full %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA = as.character(PA)) %>% 
  filter(., season == "Spring") %>% 
  filter(., ID_Microscopy =="Euphausia pacifica") %>% 
  left_join(DOH)->adult_data_chem_eu_pac
  
  ggplot(data = world) +
   geom_sf() +
    geom_point(data=adult_data_chem_eu_pac, aes(x = Lon_Dec, y = Lat_Dec,colour=Depth_of_hypoxia),alpha=0.2 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(.~season) +scale_colour_viridis_c(option = "mako", direction=-1, begin = 0,
  end = 0.7) + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) -> depth_of_hypoxia
  
   
ggplot(data = world) +
   geom_sf() +
    geom_point(data=adult_data_chem_eu_pac, aes(x = Lon_Dec, y = Lat_Dec, shape=PA, color=PA),alpha=0.1 ) +
    coord_sf(xlim = c(min_lon-1, max_lon+1), ylim = c(min_lat-0.5, max_lat+0.5), expand = FALSE) +theme_bw() +xlab("Longitude") +ylab("Latitude") +facet_wrap(.~season)  + theme(plot.title = element_text(hjust = 0.5,size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) -> krill_detections


depth_of_hypoxia + krill_detections

adult_data_chem_eu_pac$Depth_of_hypoxia
```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=20, fig.height=12}

suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=PA, x=mean_temp)) + geom_point(alpha=0.4) +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(
    method="glm",
    method.args=list(family="binomial"),
  ) +
  stat_poly_eq(use_label(c("adj.R2", "p")),label.y.npc = 0.7) +xlab("Average Temperature Upper 210m") + ylab("Presence/Absence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
}) 
```


<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>


## Oxygen

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=12, fig.height=12}

suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=log10(Count_permsq2+1), x=mean_O2Sat)) + geom_point() +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(method = "lm") + stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.. , ")")),
                                                                                                                                size = 2.5, label.x.npc = "right" ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.9,
                                                                                                                                 parse = TRUE) +
   stat_poly_eq(formula = my.formula,                                                                                                        aes(label = paste0(..p.value.label..)), size = 2.5, label.x.npc = 0.84 ,rr.digits = 2,coef.digits = 3,p.digits=2, label.y.npc = 0.7,
                                                                                                                                 parse = TRUE)+xlab("Average mean_O2Sat Upper 210m") + ylab("log10(Count per m^2+1)") +theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 

}) 
```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=12, fig.height=12}


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=PA, x=mean_O2Sat)) + geom_point(alpha=0.4) +facet_wrap(ID_Microscopy~., scales = "free") +   geom_smooth(
    method="glm",
    method.args=list(family="binomial"),
  ) +
  stat_poly_eq(use_label(c("adj.R2", "p")),label.y.npc = 0.7) +xlab("Average mean_O2Sat Upper 210m") + ylab("Presence/Absence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
}) 
```
<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>


# Abundance Temp + O2 Envelope
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=12, fig.height=12}

suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., PA >0) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=mean_temp, x=mean_O2ml_L, color=log10(Count_permsq2))) + geom_point(alpha=0.4) +facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + xlab("Average O2ml_L Upper 210m")+theme_pubclean() +scale_color_viridis_c( option="inferno") + ggtitle("Abundance")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 

}) 
```

## Detection Temp + O2 Envelope
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=20, fig.height=20}


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., PA >0) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=mean_temp, x=mean_O2ml_L)) + geom_point(alpha=0.4) +facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + xlab("Average O2ml_L Upper 210m")+theme_pubclean() + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
})
```

## Detection Temp + Depth of Hypoxia Envelope
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=20, fig.height=20}


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem_full %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
    mutate(., PA=as.character(PA)) %>% 
  ggplot(aes(y=T_degC, x=Depth_of_hypoxia, color=PA)) + geom_point(alpha=0.2) +facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + xlab("Average O2ml_L Upper 210m")+theme_pubclean() + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
})
```
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=20, fig.height=20}


suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., PA >0) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=mean_temp, x=mean_O2ml_L)) + geom_bin2d() +
  scale_fill_continuous(type = "viridis")  +facet_wrap(ID_Microscopy~.) +ylab("Average Temperature Upper 210m") + xlab("Average O2ml_L Upper 210m")+theme_pubclean() + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
})
```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=12, fig.height=12}

hull <- adult_data_chem %>%   filter(., Depth_bin =="Upper_210" ) %>% 
filter(., ID_Microscopy %in% c("Stylocheiron affine","Euphausia pacifica","Thysanoessa spinifera","Euphausia gibboides")) %>% 
   mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., PA >0) %>% 
  ungroup() %>% 
  group_by(ID_Microscopy) %>% 
  filter(., !is.na(mean_temp)) %>% 
  filter(., !is.na(mean_O2ml_L)) %>% 
slice(chull(mean_temp, mean_O2ml_L))

suppressWarnings({ 
 # Code that generates warning messages 
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., PA >0) %>% 
      filter(., !is.na(mean_temp)) %>% 
  filter(., !is.na(mean_O2ml_L)) %>% 
  filter(., ID_Microscopy %in% c("Stylocheiron affine","Euphausia pacifica","Thysanoessa spinifera","Euphausia gibboides")) %>%
  filter(., Depth_bin =="Upper_210" ) %>% 
  ggplot(aes(y=mean_temp, x=mean_O2ml_L, color=ID_Microscopy)) +
     geom_polygon(data = hull, alpha = 0.2, 
                 aes(fill = ID_Microscopy,colour = ID_Microscopy)) +
        geom_point(alpha=1) +
    ylab("Average Temperature Upper 210m") + xlab("Average O2ml_L Upper 210m") +theme_pubclean() +scale_color_manual(values = c("black","dodgerblue","yellow","tomato")) +
    scale_fill_manual(values = c("black","dodgerblue","yellow","tomato")) + ggtitle("Presence")+theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) 
})
```
<div style="page-break-after: always; visibility: hidden"> 
\pagebreak 
</div>

# Site - Binomial vs. SST

## Binomial | Station Run models
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}
adult_data_chem %>% 
  mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  filter(., !is.na(mean_temp)) %>% 
  filter(., !is.na(mean_O2ml_L))-> pa_adult_data


model1 <- glmer(PA ~ (1|ID_Microscopy)+mean_temp*mean_O2ml_L, data=pa_adult_data, family="binomial")
summary(model1) 
```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}
test_nest_a <- pa_adult_data %>% group_by(ID_Microscopy) %>% nest()

model_holder <- tibble(test_nest_a$ID_Microscopy)
model_holder$model <- list(0)

for (i in 1:nrow(model_holder)) {
print(i)
model_holder$model[[i]] <-
stan_glm(
PA ~ 0 + (1 + mean_temp ),
family = "binomial",
data = test_nest_a$data[[i]],
prior = normal(0, 4),

prior_intercept = normal(0, 10),
#adapt_delta = 0.99,
chains = 2,
iter = 1000
)
}



```


### Look at the models

Example Euphausia pacifica

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, fig.width=12, fig.height=12}
focalTaxon = "Euphausia pacifica"
idx = which(test_nest_a$ID_Microscopy == focalTaxon)

test_nest_a$data[[idx]] %>%
ggplot(aes(y = PA, x = mean_temp)) +
geom_point(color = "black") +
#geom_smooth(method = "glm", method.args = list(family = "binomial"), se = F) +
geom_point(
aes(y = model_holder$model[[idx]]$fitted.values, x = mean_temp),
alpha = .5,
color = "red"
) +
geom_smooth(
aes(y = model_holder$model[[idx]]$fitted.values, x = mean_temp),
method = "glm",
method.args = list(family = "binomial"),
se = F,
size = 0.5,
color = "red"
) 


test_nest_a$data[[idx]] %>%
  data_grid(mean_temp = seq_range(mean_temp, n = 51),mean_O2ml_L = seq_range(mean_O2ml_L, n = 51) ) %>%
    mutate(., ID_Microscopy=focalTaxon) %>% 
  add_fitted_draws(model_holder$model[[3]]) %>%
  ggplot(aes(x = mean_temp , y = PA)) +
  stat_lineribbon(aes(y = .value), color="darkred") +
  geom_point(data = test_nest_a$data[[idx]], color = "darkred") +
  scale_fill_brewer(palette = "Reds") +
  scale_color_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(size=14), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0,face="bold"), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'))	+ xlab("SST C") + ylab("Occurrence") + labs(fill='Confidence Interval') +
  facet_wrap(.~ID_Microscopy) +theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5,size = 18, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.text=element_text(size=12), 
        strip.text = element_text(size=16, face="bold"), 
        axis.title=element_text(size=16,face="bold"),
        legend.title = element_text( size=16, face="bold"),
        legend.text = element_text(size=14)
        ) -> T_mex_binomial_fig





```

```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE, include=FALSE}
i=1
color_palette_krill <- c("darkred","navy","darkgreen","gold2","darkorchid4","darkorange3","darkcyan","dodgerblue4","forestgreen","tomato3","black","deeppink3")

color_palette_fill <- c("Reds","Blues","Greens","Oranges","BuPu","Oranges","BuGn","PuBu","Greens","OrRd","Greys","PuRd")
i

for (i in 1:nrow(model_holder)) {
  
focalTaxon =test_nest_a$ID_Microscopy[i]

model_holder$plot[[i]] <- test_nest_a$data[[i]] %>%
  data_grid(mean_temp = seq_range(mean_temp, n = 51),mean_O2ml_L = seq_range(mean_O2ml_L, n = 51) ) %>%
    mutate(., ID_Microscopy=focalTaxon) %>% 
  add_fitted_draws(model_holder$model[[i]]) %>%
  ggplot(aes(x = mean_temp , y = PA)) +
  stat_lineribbon(aes(y = .value), color=color_palette_krill[i]) +
  geom_point(data = test_nest_a$data[[i]], color = color_palette_krill[i]) +
  scale_fill_brewer(palette = color_palette_fill[i]) +
  scale_color_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(size=14), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0,face="bold"), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'))	+ xlab("Average Temperature Upper 210m") + ylab("Occurrence") + labs(fill='Confidence Interval') +
  facet_wrap(.~ID_Microscopy) 

}
```


```{r, fig.width=20, fig.height=20,  echo=FALSE, hide=TRUE}

model_holder$plot[[1]] +model_holder$plot[[2]] +model_holder$plot[[3]] +model_holder$plot[[4]] + model_holder$plot[[5]] +model_holder$plot[[6]] +model_holder$plot[[7]] +model_holder$plot[[8]] +model_holder$plot[[9]] +model_holder$plot[[10]] +model_holder$plot[[11]] +model_holder$plot[[12]] + plot_layout(guides = "collect")

```


## Binomial | Station Run models
```{r, echo=FALSE, hide=TRUE, warnings=FALSE,message=FALSE}


adult_data_chem %>% 
    mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  filter(., Depth_bin =="Upper_210" ) %>% 
  filter(., !is.na(mean_temp)) %>% 
  filter(., !is.na(mean_O2ml_L))-> adult_data_for_modelx


m1 <- gam(Count_permsq2 ~ s(mean_temp), data = adult_data_for_modelx, method = "REML")

summary(m1)
draw(m1)
```

```{r}
adult_data_for_modelx %>% 
  group_by(ID_Microscopy) %>% 
  nest() -> test_nest_b

bayes.brms <- brm(Count_permsq2 ~ mean_temp +mean_O2ml_L , 
                  data =   test_nest_b$data[[3]],
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)


plot(bayes.brms)
summary(bayes.brms)
pp_check(bayes.brms, ndraws = 100, type = 'ecdf_overlay')

bayes.brms_int <- brm(Count_permsq2 ~ mean_temp +mean_O2ml_L+mean_temp *mean_O2ml_L , 
                  data =   test_nest_b$data[[3]],
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

plot(bayes.brms_int)
summary(bayes.brms_int)
pp_check(bayes.brms_int, ndraws = 100, type = 'ecdf_overlay')


bayes.brms_no2 <- brm(Count_permsq2 ~ mean_temp  , 
                  data =   test_nest_b$data[[3]],
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

bayes.brms_notemp <- brm(Count_permsq2 ~ mean_O2ml_L  , 
                  data =   test_nest_b$data[[3]],
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

waic1 <- waic(bayes.brms)
waic2 <- waic(bayes.brms_no2)
waic3 <- waic(bayes.brms_notemp)
waic4 <- waic(bayes.brms_int)

loo_compare(waic1, waic2,waic3,waic4)
```

```{r}

bayes.brms_bi <- brm(PA ~ mean_temp +mean_O2ml_L , 
                  data =   test_nest_b$data[[3]],
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)


plot(bayes.brms_bi)
summary(bayes.brms_bi)
pp_check(bayes.brms_bi, ndraws = 100, type = 'ecdf_overlay')

bayes.brms_int_bi <- brm(PA ~ mean_temp +mean_O2ml_L+mean_temp *mean_O2ml_L , 
                  data =   test_nest_b$data[[3]],
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

plot(bayes.brms_int)
summary(bayes.brms_int)
pp_check(bayes.brms_int, ndraws = 100, type = 'ecdf_overlay')


bayes.brms_no2_bi <- brm(PA ~ mean_temp  , 
                  data =   test_nest_b$data[[3]],
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

bayes.brms_notemp_bi <- brm(PA ~ mean_O2ml_L  , 
                  data =   test_nest_b$data[[3]],
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

waic1 <- waic(bayes.brms_bi)
waic2 <- waic(bayes.brms_no2_bi)
waic3 <- waic(bayes.brms_notemp_bi)
waic4 <- waic(bayes.brms_int_bi)

loo_compare(waic1, waic2,waic3,waic4)
```

# Krill GAM
```{r}

msms <- marginal_smooths(bayes.brms_int_bi)
summary(bayes.brms_int_bi)
pp_check(bayes.brms_int, ndraws = 100, type = 'ecdf_overlay')

mcmc_pairs(x = posterior_samples(bayes.brms_int),
           pars = c("b_Intercept", "b_mean_temp", "b_mean_O2ml_L","b_mean_temp:mean_O2ml_L"),
           off_diag_args = list(size = 1/10, alpha = 1/6),
           diag_fun = "dens")

post <- posterior_samples(bayes.brms_int)

post %>%
  ggplot(aes(x = b_Intercept)) +
  geom_density()

post %>%
  ggplot(aes(x = b_mean_temp)) +
  geom_density()

d_plot <- test_nest_b$data[[3]] 

fitted(bayes.brms_int) %>% 
  as_tibble() %>% 
  bind_cols(bayes.brms_int$data) %>% 
  mutate(., PA_c = as.character(PA)) %>% 
  ggplot(., aes(x=mean_temp,y=mean_O2ml_L)) + geom_point(aes(colour=PA_c))  -> obs_plot_eu_pac

fitted(bayes.brms_int) %>% 
  as_tibble() %>% 
  bind_cols(bayes.brms_int$data) %>% 
  mutate(., PA_c = as.character(PA)) %>% 
  mutate(., `Estimated Probability of Detection` = Estimate) %>% 
  ggplot(., aes(x=mean_temp,y=mean_O2ml_L)) + geom_point(aes(colour=`Estimated Probability of Detection`)) -> model_plot_eu_pac


obs_plot_eu_pac 
```

```{r}
adult_data_chem_full %>% 
  filter(., Depthm ==100 ) %>% 
  ggplot(aes(colour=Count_permsq2, x=T_degC, y=O2ml_L)) + geom_point() 
```

```{r}
adult_data_chem_full %>% 
  filter(., ID_Microscopy== "Euphausia pacifica") %>% 
  group_by(year_season_site) %>% 
  filter(., Depthm < 210) %>% 
  summarise(min_T= min(T_degC),min_O2= min(O2ml_L),  Count_permsq2=mean(Count_permsq2)) %>% 
      mutate(., PA = if_else(Count_permsq2 >0,1,0)) %>% 
  mutate(., PA_c=as.character(PA)) %>% 
  ggplot(aes( x=min_T, y=min_O2))  + geom_point(data = cast_bottle_fixed_min_value, aes(x=min_T, y=min_O2), alpha=0.02)+ geom_point(aes(colour=PA_c, x=min_T, y=min_O2)) +facet_wrap(~PA_c)
```
```{r}
cast_bottle_fixed %>% 
  group_by(year_season_site,season) %>% 
  filter(., Depthm < 210) %>% 
  filter(., O2ml_L > 0) %>% 
  summarise(min_T= min(T_degC),min_O2= min(O2ml_L)) -> cast_bottle_fixed_min_value

cast_bottle_fixed_min_value %>% 
  ggplot(aes(x=min_T, y=min_O2)) + geom_point() +facet_wrap(~season)
```


```{r}
model_plot_eu_pac
```

```{r}

get_variables(bayes.brms_int)

bayes.brms_int %>%
  spread_draws(b_Intercept,b_mean_temp, b_mean_O2ml_L,`b_mean_temp:mean_O2ml_L`)


```

```{r}

bayes.brms_bi_species <- brm(PA ~ mean_temp +mean_O2ml_L + (1|ID_Microscopy) , 
                  data =   adult_data_for_modelx,
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)
summary(bayes.brms_bi_species)

bayes.brms_bi_species_random <- brm(PA ~ mean_temp +mean_O2ml_L + (1+ mean_temp + mean_O2ml_L|ID_Microscopy) , 
                  data =   adult_data_for_modelx,
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)
summary(bayes.brms_bi_species_random)
bayes.brms_bi_species_random_int <- brm(PA ~ mean_temp +mean_O2ml_L +mean_temp *mean_O2ml_L+ (1+ mean_temp +mean_O2ml_L +mean_temp *mean_O2ml_L|ID_Microscopy) , 
                  data =   adult_data_for_modelx,
                              family = bernoulli,
                  chains = 2, # nb of chains
                  iter = 5000, # nb of iterations, including burnin
                  warmup = 1000, # burnin
                  thin = 1)

```

```{r}
library(flocker)
library(brms)
set.seed(1)

```


